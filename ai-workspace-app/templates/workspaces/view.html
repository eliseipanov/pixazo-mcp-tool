{% extends "base.html" %}

{% block title %}{{ workspace.name }} - AI Workspace{% endblock %}

{% block workspace_actions %}
<div class="d-flex align-items-center gap-2 ms-3">
    <a href="{{ url_for('edit_workspace', workspace_id=workspace.id) }}" class="btn btn-sm btn-outline-secondary" title="Edit Workspace">
        <i class="bi bi-pencil"></i>
    </a>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="saveWorkspace()" title="Save Workspace">
        <i class="bi bi-save"></i>
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportWorkspace()" title="Export Workspace">
        <i class="bi bi-download"></i>
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="importWorkspace()" title="Import Workspace">
        <i class="bi bi-upload"></i>
    </button>
    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" title="Delete Workspace">
        <i class="bi bi-trash"></i>
    </button>
    <div class="vr mx-1"></div>
    <button type="button" class="btn btn-sm btn-primary" id="chatToggleBtn" title="Toggle Chat">
        <i class="bi bi-chat-dots"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="workspace-container d-flex">
    <!-- Left Sidebar (Resizable: 320px-420px) -->
    <aside class="sidebar" id="sidebar" style="width: 320px;">
        <!-- Resize Handle -->
        <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>
        
        <!-- Workspace Header -->
        <div class="sidebar-header">
            <h5 class="mb-0 text-truncate">{{ workspace.name }}</h5>
            <small class="text-muted text-truncate">{{ workspace.description or 'No description' }}</small>
        </div>
        
        <!-- Navigation Menu (Collapsible) -->
        <div class="sidebar-section">
            <div class="nav-menu-header" id="navMenuHeader">
                <span><i class="bi bi-list"></i> Navigation</span>
                <i class="bi bi-chevron-down" id="navMenuToggle"></i>
            </div>
            <div class="nav-menu-content" id="navMenuContent">
                <a href="{{ url_for('index') }}" class="nav-item">
                    <i class="bi bi-house"></i> Home
                </a>
                <a href="{{ url_for('list_workspaces') }}" class="nav-item">
                    <i class="bi bi-grid"></i> Workspaces
                </a>
                <a href="{{ url_for('list_themes') }}" class="nav-item">
                    <i class="bi bi-palette"></i> Themes
                </a>
                <a href="{{ url_for('list_styles', workspace_id=workspace.id) }}" class="nav-item">
                    <i class="bi bi-brush"></i> Styles
                </a>
                {% if current_user.is_superuser %}
                <a href="{{ url_for('list_models') }}" class="nav-item">
                    <i class="bi bi-cpu"></i> Models
                </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Prompt Form (Always Visible) -->
        <div class="sidebar-section flex-grow-1">
            <div class="section-header">
                <i class="bi bi-magic"></i> Generate Image
            </div>
            <form id="generateForm" method="POST" action="{{ url_for('generate_image', workspace_id=workspace.id) }}">
                <!-- Saved Prompts Dropdown -->
                <div class="mb-3">
                    <label for="saved_prompt_select" class="form-label small">Load Saved Prompt</label>
                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="saved_prompt_select">
                        <option value="">-- Select Saved Prompt --</option>
                    </select>
                </div>
                
                <!-- Main Prompt -->
                <div class="mb-3">
                    <label for="main_prompt" class="form-label small">Main Prompt <span class="text-danger">*</span></label>
                    <textarea class="form-control bg-dark text-light border-secondary" id="main_prompt" name="main_prompt" rows="3" required placeholder="Describe the image you want to generate..."></textarea>
                </div>
                
                <!-- Negative Prompt -->
                <div class="mb-3">
                    <label for="negative_prompt" class="form-label small">Negative Prompt</label>
                    <textarea class="form-control bg-dark text-light border-secondary" id="negative_prompt" name="negative_prompt" rows="2" placeholder="Describe what to avoid..."></textarea>
                </div>
                
                <!-- Theme Selection -->
                <div class="mb-3">
                    <label for="theme_id" class="form-label small">Theme</label>
                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="theme_id" name="theme_id">
                        <option value="">-- No Theme --</option>
                        {% for theme in themes %}
                        <option value="{{ theme.id }}">{{ theme.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Style Selection -->
                <div class="mb-3">
                    <label for="style_id" class="form-label small">Style</label>
                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="style_id" name="style_id">
                        <option value="">-- No Style --</option>
                        {% for style in workspace.styles %}
                        <option value="{{ style.id }}" data-model="{{ style.model }}">{{ style.name }} ({{ style.model|upper }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Model Selection -->
                <div class="mb-3">
                    <label for="model_id" class="form-label small">Model <span class="text-danger">*</span></label>
                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="model_id" name="model_id" required>
                        <option value="">-- Select Model --</option>
                    </select>
                </div>
                
                <!-- Advanced Parameters -->
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100" data-bs-toggle="collapse" data-bs-target="#advancedParams">
                        <i class="bi bi-gear"></i> Advanced Parameters
                    </button>
                </div>
                
                <div class="collapse" id="advancedParams">
                    <div class="row g-2">
                        <div class="col-6 mb-2">
                            <label for="width" class="form-label small">Width</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" id="width" name="width" value="768" min="256" max="1536">
                        </div>
                        <div class="col-6 mb-2">
                            <label for="height" class="form-label small">Height</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" id="height" name="height" value="1024" min="256" max="2048">
                        </div>
                        <div class="col-6 mb-2">
                            <label for="num_steps" class="form-label small">Steps</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" id="num_steps" name="num_steps" value="20" min="10" max="50">
                        </div>
                        <div class="col-6 mb-2">
                            <label for="guidance_scale" class="form-label small">Guidance</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" id="guidance_scale" name="guidance_scale" value="8.0" min="1.0" max="20.0" step="0.5">
                        </div>
                        <div class="col-12 mb-2">
                            <label for="seed" class="form-label small">Seed</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" id="seed" name="seed" placeholder="Random">
                        </div>
                    </div>
                </div>
                
                <!-- Generate Button -->
                <div class="mb-3">
                    <button type="submit" class="btn btn-primary w-100" id="generateBtn">
                        <i class="bi bi-magic"></i> Generate Image
                    </button>
                    <span id="generateStatus" class="d-block text-center mt-2 small"></span>
                </div>
                
                <!-- Save Prompt Checkbox -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="save_prompt" name="save_prompt">
                        <label class="form-check-label small" for="save_prompt">
                            Save this prompt
                        </label>
                    </div>
                </div>
            </form>
        </div>
    </aside>
    
    <!-- Main Canvas Area -->
    <main class="canvas-area flex-grow-1">
        <!-- Generated Images -->
        <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="bi bi-images"></i> Generated Images ({{ workspace.generated_images|length }})</h5>
            </div>
            <div class="card-body">
                {% if workspace.generated_images %}
                <div class="row g-3">
                    {% for image in workspace.generated_images %}
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card bg-dark border-secondary h-100 position-relative">
                            <!-- Thumbnail with action icons -->
                            <div class="position-relative">
                                {% if image.thumbnail_path %}
                                <a href="{{ url_for('serve_generated_image', filename=image.thumbnail_path.replace('/var/www/pixazo/data/generated/', '')) }}" 
                                   data-bs-toggle="modal" 
                                   data-bs-target="#lightboxModal" 
                                   data-image-id="{{ image.id }}"
                                   data-image-url="{{ url_for('serve_generated_image', filename=image.path.replace('/var/www/pixazo/data/generated/', '')) }}"
                                   class="thumbnail-link">
                                    <img src="{{ url_for('serve_generated_image', filename=image.thumbnail_path.replace('/var/www/pixazo/data/generated/', '')) }}" 
                                         class="card-img-top" 
                                         alt="Generated image" 
                                         style="height: 200px; object-fit: cover;">
                                </a>
                                {% elif image.path %}
                                <a href="{{ url_for('serve_generated_image', filename=image.path.replace('/var/www/pixazo/data/generated/', '')) }}" 
                                   data-bs-toggle="modal" 
                                   data-bs-target="#lightboxModal" 
                                   data-image-id="{{ image.id }}"
                                   data-image-url="{{ url_for('serve_generated_image', filename=image.path.replace('/var/www/pixazo/data/generated/', '')) }}"
                                   class="thumbnail-link">
                                    <img src="{{ url_for('serve_generated_image', filename=image.path.replace('/var/www/pixazo/data/generated/', '')) }}" 
                                         class="card-img-top" 
                                         alt="Generated image" 
                                         style="height: 200px; object-fit: cover;">
                                </a>
                                {% else %}
                                <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <i class="bi bi-image display-4 text-muted"></i>
                                </div>
                                {% endif %}
                                
                                <!-- Action Icons -->
                                <div class="image-actions">
                                    <button type="button" 
                                            class="btn btn-sm btn-dark action-icon" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#lightboxModal"
                                            data-image-id="{{ image.id }}"
                                            data-image-url="{{ url_for('serve_generated_image', filename=image.path.replace('/var/www/pixazo/data/generated/', '')) }}"
                                            title="View Full Size">
                                        <i class="bi bi-zoom-in"></i>
                                    </button>
                                    <a href="{{ url_for('serve_generated_image', filename=image.path.replace('/var/www/pixazo/data/generated/', '')) }}" 
                                       download
                                       class="btn btn-sm btn-dark action-icon"
                                       title="Download Full Image">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-sm btn-dark action-icon" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#imageInfoModal"
                                            data-image-id="{{ image.id }}"
                                            data-prompt="{{ image.prompt }}"
                                            data-negative-prompt="{{ image.negative_prompt or '' }}"
                                            data-seed="{{ image.seed or '' }}"
                                            title="Image Info">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-dark action-icon delete-btn" 
                                            data-image-id="{{ image.id }}"
                                            title="Delete Image">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-dark action-icon reuse-btn" 
                                            data-prompt="{{ image.prompt }}"
                                            data-negative-prompt="{{ image.negative_prompt or '' }}"
                                            data-seed="{{ image.seed or '' }}"
                                            data-model="{{ image.model }}"
                                            data-width="{{ image.width }}"
                                            data-height="{{ image.height }}"
                                            data-steps="{{ image.num_steps }}"
                                            data-guidance="{{ image.guidance_scale }}"
                                            title="Reuse Prompt">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <p class="card-text small text-muted mb-1 text-truncate">{{ image.prompt[:50] }}{% if image.prompt|length > 50 %}...{% endif %}</p>
                                <small class="text-muted d-block">
                                    <i class="bi bi-cpu"></i> {{ image.model|upper }} | 
                                    {{ image.width }}x{{ image.height }} | 
                                    {{ image.created_at.strftime('%Y-%m-%d %H:%M') }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state text-center py-5">
                    <i class="bi bi-image display-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No images generated yet</h5>
                    <p class="text-muted">Use the form in the sidebar to generate your first image.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>

<!-- Floating Chat Window -->
<div class="chat-window" id="chatWindow" style="display: none;">
    <div class="chat-header" id="chatHeader">
        <span><i class="bi bi-chat-dots"></i> Chat with AI</span>
        <div class="chat-header-controls">
            <button type="button" class="btn btn-sm btn-link text-light p-0" id="chatCollapseBtn">
                <i class="bi bi-dash"></i>
            </button>
            <button type="button" class="btn btn-sm btn-link text-light p-0" id="chatCloseBtn">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="chat-messages" id="chatMessages">
            <div class="text-center text-muted py-3">
                <small>Start a conversation to improve your prompts</small>
            </div>
        </div>
    </div>
    <div class="chat-footer" id="chatFooter">
        <div class="input-group">
            <input type="text" class="form-control bg-dark text-light border-secondary" id="chatInput" placeholder="Type a message...">
            <button class="btn btn-primary" type="button" id="chatSendBtn">
                <i class="bi bi-send"></i>
            </button>
        </div>
    </div>
    <!-- Resize Handle -->
    <div class="chat-resize-handle" id="chatResizeHandle"></div>
</div>

<!-- Delete Workspace Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Delete Workspace</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ workspace.name }}</strong>?</p>
                <p class="text-danger small">This will also delete all associated styles, chat messages, and generated images. This action cannot be undone.</p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('delete_workspace', workspace_id=workspace.id) }}" method="POST">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox Modal -->
<div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Full Size Image</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 text-center">
                <img id="lightboxImage" src="" alt="Full size image" class="img-fluid">
            </div>
            <div class="modal-footer border-secondary">
                <a id="lightboxDownload" href="" download class="btn btn-primary">
                    <i class="bi bi-download"></i> Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Info Modal -->
<div class="modal fade" id="imageInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Image Information</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small text-muted">Prompt</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="infoPrompt" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('infoPrompt')">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Negative Prompt</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="infoNegativePrompt" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('infoNegativePrompt')">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Seed</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="infoSeed" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('infoSeed')">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== Sidebar Resize ====================
const sidebar = document.getElementById('sidebar');
const sidebarResizeHandle = document.getElementById('sidebarResizeHandle');
let isResizingSidebar = false;

// Load saved sidebar width
const savedSidebarWidth = localStorage.getItem('sidebar_width');
if (savedSidebarWidth) {
    sidebar.style.width = savedSidebarWidth + 'px';
}

sidebarResizeHandle.addEventListener('mousedown', (e) => {
    isResizingSidebar = true;
    e.preventDefault();
});

document.addEventListener('mousemove', (e) => {
    if (!isResizingSidebar) return;
    
    const newWidth = e.clientX;
    if (newWidth >= 320 && newWidth <= 420) {
        sidebar.style.width = newWidth + 'px';
    }
});

document.addEventListener('mouseup', () => {
    if (isResizingSidebar) {
        isResizingSidebar = false;
        localStorage.setItem('sidebar_width', parseInt(sidebar.style.width));
    }
});

// ==================== Navigation Menu Toggle ====================
const navMenuHeader = document.getElementById('navMenuHeader');
const navMenuContent = document.getElementById('navMenuContent');
const navMenuToggle = document.getElementById('navMenuToggle');

// Load saved nav menu state
const savedNavMenuCollapsed = localStorage.getItem('navMenu_collapsed');
if (savedNavMenuCollapsed === 'true') {
    navMenuContent.style.display = 'none';
    navMenuToggle.classList.remove('bi-chevron-down');
    navMenuToggle.classList.add('bi-chevron-right');
}

navMenuHeader.addEventListener('click', () => {
    const isCollapsed = navMenuContent.style.display === 'none';
    navMenuContent.style.display = isCollapsed ? 'block' : 'none';
    navMenuToggle.classList.toggle('bi-chevron-down');
    navMenuToggle.classList.toggle('bi-chevron-right');
    localStorage.setItem('navMenu_collapsed', !isCollapsed);
});

// ==================== Chat Window ====================
const chatWindow = document.getElementById('chatWindow');
const chatHeader = document.getElementById('chatHeader');
const chatToggleBtn = document.getElementById('chatToggleBtn');
const chatCollapseBtn = document.getElementById('chatCollapseBtn');
const chatCloseBtn = document.getElementById('chatCloseBtn');
const chatBody = document.getElementById('chatBody');
const chatFooter = document.getElementById('chatFooter');
const chatResizeHandle = document.getElementById('chatResizeHandle');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
const chatMessages = document.getElementById('chatMessages');

let isDraggingChat = false;
let isResizingChat = false;
let chatOffset = { x: 0, y: 0 };
let chatResizeOffset = { x: 0, y: 0 };

// Load saved chat state
const savedChatVisible = localStorage.getItem('chatWindow_visible');
const savedChatPosition = JSON.parse(localStorage.getItem('chatWindow_position') || '{"x": 0, "y": 0}');
const savedChatSize = JSON.parse(localStorage.getItem('chatWindow_size') || '{"width": 400, "height": 500}');
const savedChatCollapsed = localStorage.getItem('chatWindow_collapsed') === 'true';

// Set initial state
if (savedChatVisible === 'true') {
    chatWindow.style.display = 'block';
    chatToggleBtn.classList.remove('btn-primary');
    chatToggleBtn.classList.add('btn-success');
}

// Set position (first time centered, then saved position)
if (savedChatPosition.x === 0 && savedChatPosition.y === 0) {
    // Center on screen
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    chatWindow.style.left = (viewportWidth / 2 - savedChatSize.width / 2) + 'px';
    chatWindow.style.top = (viewportHeight / 2 - savedChatSize.height / 2) + 'px';
} else {
    chatWindow.style.left = savedChatPosition.x + 'px';
    chatWindow.style.top = savedChatPosition.y + 'px';
}

// Set size
chatWindow.style.width = savedChatSize.width + 'px';
chatWindow.style.height = savedChatSize.height + 'px';

// Set collapsed state
if (savedChatCollapsed) {
    chatBody.style.display = 'none';
    chatFooter.style.display = 'none';
    chatWindow.style.height = 'auto';
}

// Toggle chat window
chatToggleBtn.addEventListener('click', () => {
    const isVisible = chatWindow.style.display !== 'none';
    chatWindow.style.display = isVisible ? 'none' : 'block';
    if (isVisible) {
        chatToggleBtn.classList.remove('btn-success');
        chatToggleBtn.classList.add('btn-primary');
    } else {
        chatToggleBtn.classList.remove('btn-primary');
        chatToggleBtn.classList.add('btn-success');
    }
    localStorage.setItem('chatWindow_visible', !isVisible);
});

// Collapse chat window
chatCollapseBtn.addEventListener('click', () => {
    const isCollapsed = chatBody.style.display === 'none';
    chatBody.style.display = isCollapsed ? 'block' : 'none';
    chatFooter.style.display = isCollapsed ? 'block' : 'none';
    chatCollapseBtn.querySelector('i').classList.toggle('bi-dash');
    chatCollapseBtn.querySelector('i').classList.toggle('bi-plus');
    localStorage.setItem('chatWindow_collapsed', !isCollapsed);
});

// Close chat window
chatCloseBtn.addEventListener('click', () => {
    chatWindow.style.display = 'none';
    chatToggleBtn.classList.remove('btn-success');
    chatToggleBtn.classList.add('btn-primary');
    localStorage.setItem('chatWindow_visible', 'false');
});

// Drag chat window
chatHeader.addEventListener('mousedown', (e) => {
    if (e.target.closest('button')) return; // Don't drag if clicking buttons
    isDraggingChat = true;
    chatOffset.x = e.clientX - chatWindow.offsetLeft;
    chatOffset.y = e.clientY - chatWindow.offsetTop;
    chatHeader.style.cursor = 'grabbing';
});

document.addEventListener('mousemove', (e) => {
    if (!isDraggingChat) return;
    
    let newX = e.clientX - chatOffset.x;
    let newY = e.clientY - chatOffset.y;
    
    // Keep within viewport
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const chatWidth = chatWindow.offsetWidth;
    const chatHeight = chatWindow.offsetHeight;
    
    newX = Math.max(0, Math.min(newX, viewportWidth - chatWidth));
    newY = Math.max(0, Math.min(newY, viewportHeight - chatHeight));
    
    chatWindow.style.left = newX + 'px';
    chatWindow.style.top = newY + 'px';
});

document.addEventListener('mouseup', () => {
    if (isDraggingChat) {
        isDraggingChat = false;
        chatHeader.style.cursor = 'grab';
        localStorage.setItem('chatWindow_position', JSON.stringify({
            x: parseInt(chatWindow.style.left),
            y: parseInt(chatWindow.style.top)
        }));
    }
});

// Resize chat window
chatResizeHandle.addEventListener('mousedown', (e) => {
    isResizingChat = true;
    chatResizeOffset.x = e.clientX;
    chatResizeOffset.y = e.clientY;
    e.preventDefault();
});

document.addEventListener('mousemove', (e) => {
    if (!isResizingChat) return;
    
    const deltaX = e.clientX - chatResizeOffset.x;
    const deltaY = e.clientY - chatResizeOffset.y;
    
    const currentWidth = parseInt(chatWindow.style.width);
    const currentHeight = parseInt(chatWindow.style.height);
    
    const newWidth = Math.max(300, Math.min(currentWidth + deltaX, 600));
    const newHeight = Math.max(200, Math.min(currentHeight + deltaY, 800));
    
    chatWindow.style.width = newWidth + 'px';
    chatWindow.style.height = newHeight + 'px';
    
    chatResizeOffset.x = e.clientX;
    chatResizeOffset.y = e.clientY;
});

document.addEventListener('mouseup', () => {
    if (isResizingChat) {
        isResizingChat = false;
        localStorage.setItem('chatWindow_size', JSON.stringify({
            width: parseInt(chatWindow.style.width),
            height: parseInt(chatWindow.style.height)
        }));
    }
});

// Send chat message
chatSendBtn.addEventListener('click', sendChatMessage);
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendChatMessage();
    }
});

function sendChatMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    
    // Add user message to chat
    addChatMessage('user', message);
    chatInput.value = '';
    
    // TODO: Send to API and get response
    // For now, just echo back
    setTimeout(() => {
        addChatMessage('assistant', 'This is a placeholder response. Chat API integration coming soon!');
    }, 500);
}

function addChatMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role === 'user' ? 'user' : 'assistant'}`;
    messageDiv.innerHTML = `
        <span class="chat-role">${role === 'user' ? 'You' : 'AI'}</span>
        <p class="chat-content">${content}</p>
    `;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ==================== Load Models ====================
let availableModels = [];

function loadModels() {
    fetch('/api/models')
        .then(response => response.json())
        .then(data => {
            availableModels = data.models;
            const modelSelect = document.getElementById('model_id');
            modelSelect.innerHTML = '<option value="">-- Select Model --</option>';
            
            availableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.display_name;
                option.dataset.defaultWidth = model.default_width;
                option.dataset.defaultHeight = model.default_height;
                option.dataset.defaultSteps = model.default_steps;
                option.dataset.defaultGuidanceScale = model.default_guidance_scale;
                option.dataset.maxWidth = model.max_width;
                option.dataset.maxHeight = model.max_height;
                option.dataset.minSteps = model.min_steps;
                option.dataset.maxSteps = model.max_steps;
                option.dataset.minGuidanceScale = model.min_guidance_scale;
                option.dataset.maxGuidanceScale = model.max_guidance_scale;
                modelSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading models:', error);
        });
}

// Handle model selection
document.getElementById('model_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const model = availableModels.find(m => m.id == this.value);
    
    if (model) {
        document.getElementById('width').value = model.default_width;
        document.getElementById('height').value = model.default_height;
        document.getElementById('num_steps').value = model.default_steps;
        document.getElementById('guidance_scale').value = model.default_guidance_scale;
        
        document.getElementById('width').min = 256;
        document.getElementById('width').max = model.max_width;
        document.getElementById('height').min = 256;
        document.getElementById('height').max = model.max_height;
        document.getElementById('num_steps').min = model.min_steps;
        document.getElementById('num_steps').max = model.max_steps;
        document.getElementById('guidance_scale').min = model.min_guidance_scale;
        document.getElementById('guidance_scale').max = model.max_guidance_scale;
    }
});

// Handle style selection
document.getElementById('style_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const modelName = selectedOption.getAttribute('data-model');
    if (modelName) {
        const model = availableModels.find(m => m.name === modelName);
        if (model) {
            document.getElementById('model_id').value = model.id;
            document.getElementById('model_id').dispatchEvent(new Event('change'));
        }
    }
});

// ==================== Form Submission ====================
document.getElementById('generateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    const generateBtn = document.getElementById('generateBtn');
    const generateStatus = document.getElementById('generateStatus');
    const savePromptCheckbox = document.getElementById('save_prompt');
    
    // Check if prompt should be saved
    if (savePromptCheckbox.checked) {
        const promptName = prompt('Enter a name for this prompt:', 'Untitled');
        if (promptName) {
            const saveData = {
                name: promptName,
                main_prompt: formData.get('main_prompt'),
                negative_prompt: formData.get('negative_prompt'),
                theme_id: formData.get('theme_id'),
                style_id: formData.get('style_id'),
                model_id: formData.get('model_id'),
                width: formData.get('width'),
                height: formData.get('height'),
                num_steps: formData.get('num_steps'),
                guidance_scale: formData.get('guidance_scale'),
                seed: formData.get('seed')
            };
            
            fetch(`/api/workspaces/{{ workspace.id }}/saved-prompts`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(saveData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Prompt saved successfully');
                    loadSavedPrompts();
                    generateImage();
                } else {
                    generateStatus.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle"></i> Failed to save prompt: ' + (data.error || 'Unknown error') + '</span>';
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="bi bi-magic"></i> Generate Image';
                }
            })
            .catch(error => {
                console.error('Error saving prompt:', error);
                generateStatus.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle"></i> Failed to save prompt: ' + error.message + '</span>';
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="bi bi-magic"></i> Generate Image';
            });
        } else {
            generateImage();
        }
    } else {
        generateImage();
    }
});

function generateImage() {
    const form = document.getElementById('generateForm');
    const formData = new FormData(form);
    const generateBtn = document.getElementById('generateBtn');
    const generateStatus = document.getElementById('generateStatus');
    
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
    generateStatus.innerHTML = '<span class="text-info"><i class="bi bi-hourglass-split"></i> Generating image, please wait...</span>';
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            generateStatus.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Image generated successfully!</span>';
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            generateStatus.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle"></i> ' + (data.error || 'Generation failed') + '</span>';
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="bi bi-magic"></i> Generate Image';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        generateStatus.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle"></i> Network error. Please try again.</span>';
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="bi bi-magic"></i> Generate Image';
    });
}

// ==================== Saved Prompts ====================
let savedPrompts = [];

function loadSavedPrompts() {
    fetch(`/api/workspaces/{{ workspace.id }}/saved-prompts`)
        .then(response => response.json())
        .then(data => {
            savedPrompts = data.saved_prompts;
            const savedPromptSelect = document.getElementById('saved_prompt_select');
            savedPromptSelect.innerHTML = '<option value="">-- Select Saved Prompt --</option>';
            
            savedPrompts.forEach(sp => {
                const option = document.createElement('option');
                option.value = sp.id;
                option.textContent = sp.name;
                savedPromptSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading saved prompts:', error);
        });
}

document.getElementById('saved_prompt_select').addEventListener('change', function() {
    const savedPromptId = this.value;
    if (!savedPromptId) return;
    
    const savedPrompt = savedPrompts.find(sp => sp.id == savedPromptId);
    if (savedPrompt) {
        document.getElementById('main_prompt').value = savedPrompt.main_prompt;
        document.getElementById('negative_prompt').value = savedPrompt.negative_prompt || '';
        document.getElementById('theme_id').value = savedPrompt.theme_id || '';
        document.getElementById('style_id').value = savedPrompt.style_id || '';
        document.getElementById('model_id').value = savedPrompt.model_id || '';
        document.getElementById('width').value = savedPrompt.width || '';
        document.getElementById('height').value = savedPrompt.height || '';
        document.getElementById('num_steps').value = savedPrompt.num_steps || '';
        document.getElementById('guidance_scale').value = savedPrompt.guidance_scale || '';
        document.getElementById('seed').value = savedPrompt.seed || '';
        
        document.getElementById('model_id').dispatchEvent(new Event('change'));
        document.getElementById('style_id').dispatchEvent(new Event('change'));
    }
});

// ==================== Workspace Actions ====================
function saveWorkspace() {
    alert('Save workspace functionality coming soon!');
}

function exportWorkspace() {
    alert('Export workspace functionality coming soon!');
}

function importWorkspace() {
    alert('Import workspace functionality coming soon!');
}

// ==================== Initialize ====================
loadModels();
loadSavedPrompts();

// ==================== Image Actions ====================
// Lightbox Modal
const lightboxModal = new bootstrap.Modal(document.getElementById('lightboxModal'));
const lightboxImage = document.getElementById('lightboxImage');
const lightboxDownload = document.getElementById('lightboxDownload');

// Image Info Modal
const imageInfoModal = new bootstrap.Modal(document.getElementById('imageInfoModal'));
const infoPrompt = document.getElementById('infoPrompt');
const infoNegativePrompt = document.getElementById('infoNegativePrompt');
const infoSeed = document.getElementById('infoSeed');

// Copy to clipboard function
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(element.value).then(() => {
        // Show brief success feedback
        const originalText = element.value;
        element.value = 'Copied!';
        setTimeout(() => {
            element.value = originalText;
        }, 1000);
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// Handle lightbox modal show
document.querySelectorAll('[data-bs-target="#lightboxModal"]').forEach(button => {
    button.addEventListener('click', function() {
        const imageUrl = this.getAttribute('data-image-url');
        lightboxImage.src = imageUrl;
        lightboxDownload.href = imageUrl;
        lightboxModal.show();
    });
});

// Handle image info modal show
document.querySelectorAll('[data-bs-target="#imageInfoModal"]').forEach(button => {
    button.addEventListener('click', function() {
        const prompt = this.getAttribute('data-prompt');
        const negativePrompt = this.getAttribute('data-negative-prompt');
        const seed = this.getAttribute('data-seed');
        
        infoPrompt.value = prompt;
        infoNegativePrompt.value = negativePrompt;
        infoSeed.value = seed;
        
        imageInfoModal.show();
    });
});

// Handle delete image
document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', function() {
        const imageId = this.getAttribute('data-image-id');
        
        if (confirm('Are you sure you want to delete this image?')) {
            fetch(`/api/images/${imageId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    // Remove image card from DOM
                    const imageCard = this.closest('.col-6, .col-md-4, .col-lg-3');
                    if (imageCard) {
                        imageCard.remove();
                    }
                } else {
                    alert('Failed to delete image');
                }
            })
            .catch(error => {
                console.error('Error deleting image:', error);
                alert('Error deleting image: ' + error.message);
            });
        }
    });
});

// Handle reuse prompt
document.querySelectorAll('.reuse-btn').forEach(button => {
    button.addEventListener('click', function() {
        const prompt = this.getAttribute('data-prompt');
        const negativePrompt = this.getAttribute('data-negative-prompt');
        const seed = this.getAttribute('data-seed');
        const model = this.getAttribute('data-model');
        const width = this.getAttribute('data-width');
        const height = this.getAttribute('data-height');
        const steps = this.getAttribute('data-steps');
        const guidance = this.getAttribute('data-guidance');
        
        // Fill form with reused parameters
        document.getElementById('main_prompt').value = prompt;
        document.getElementById('negative_prompt').value = negativePrompt;
        document.getElementById('seed').value = seed;
        
        // Find and select model
        const modelSelect = document.getElementById('model_id');
        const modelOption = Array.from(modelSelect.options).find(option => option.text === model);
        if (modelOption) {
            modelSelect.value = modelOption.value;
            modelSelect.dispatchEvent(new Event('change'));
        }
        
        // Set other parameters
        if (width) document.getElementById('width').value = width;
        if (height) document.getElementById('height').value = height;
        if (steps) document.getElementById('num_steps').value = steps;
        if (guidance) document.getElementById('guidance_scale').value = guidance;
        
        // Scroll to form
        document.getElementById('main_prompt').scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
});
</script>

<style>
.workspace-container {
    height: calc(100vh - 56px); /* Subtract navbar height */
    overflow: hidden;
}

.sidebar {
    background: #1a1a1a;
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
    flex-shrink: 0;
}

.sidebar-resize-handle {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 5px;
    cursor: col-resize;
    background: #333;
    transition: background 0.2s;
}

.sidebar-resize-handle:hover {
    background: #007bff;
}

.sidebar-header {
    padding: 1rem;
    border-bottom: 1px solid #333;
}

.sidebar-section {
    padding: 1rem;
    border-bottom: 1px solid #333;
}

.section-header {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #adb5bd;
}

.nav-menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 0.5rem 0;
    font-weight: 600;
    color: #adb5bd;
}

.nav-menu-header:hover {
    color: #fff;
}

.nav-menu-content {
    display: block;
}

.nav-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
    color: #adb5bd;
    text-decoration: none;
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
    transition: all 0.2s;
}

.nav-item:hover {
    background: #333;
    color: #fff;
}

.nav-item i {
    margin-right: 0.5rem;
}

.canvas-area {
    padding: 1.5rem;
    overflow-y: auto;
    background: #0f0f0f;
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
}

/* Chat Window */
.chat-window {
    position: fixed;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    min-width: 300px;
    min-height: 200px;
    max-width: 600px;
    max-height: 800px;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #333;
    cursor: grab;
    background: #252525;
    border-radius: 0.5rem 0.5rem 0 0;
}

.chat-header:active {
    cursor: grabbing;
}

.chat-header-controls {
    display: flex;
    gap: 0.5rem;
}

.chat-body {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
    max-height: calc(100% - 120px);
}

.chat-messages {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.chat-message {
    padding: 0.75rem;
    border-radius: 0.5rem;
    max-width: 80%;
}

.chat-message.user {
    align-self: flex-end;
    background: #007bff;
    color: #fff;
}

.chat-message.assistant {
    align-self: flex-start;
    background: #333;
    color: #adb5bd;
}

.chat-role {
    font-size: 0.75rem;
    font-weight: 600;
    display: block;
    margin-bottom: 0.25rem;
}

.chat-content {
    margin: 0;
    font-size: 0.875rem;
    line-height: 1.5;
}

.chat-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid #333;
}

.chat-resize-handle {
    position: absolute;
    right: 0;
    bottom: 0;
    width: 15px;
    height: 15px;
    cursor: nwse-resize;
    background: linear-gradient(135deg, transparent 50%, #333 50%);
}

.chat-resize-handle:hover {
    background: linear-gradient(135deg, transparent 50%, #007bff 50%);
}
</style>
{% endblock %}
